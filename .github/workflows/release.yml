name: Release Build - AAR Only

on:
  push:
    branches:
      - dev*
    paths:
      - "app/**"
      - "buildSrc/**"
      - "library/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:  

jobs:
  build-aar:
    name: Build LibCore AAR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25.5
          cache-dependency-path: "library/core/go.sum"

      - name: Setup Go Mobile
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@v0.1.8
          go install github.com/sagernet/gomobile/cmd/gobind@v0.1.8

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: 21
          cache: 'gradle'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29

      - name: Native Build (Generate libcore.aar)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          ./run lib core

      - name: Upload libcore.aar as Artifact
        uses: actions/upload-artifact@v5
        with:
          name: libcore-aar
          path: app/libs/libcore.aar
          retention-days: 90

      - name: Notify Success (Optional)
        run: |
          echo "✅ libcore.aar 已成功构建并上传为 Artifact，可在 Actions 页面下载。"
